

# SillyTavern 酒馆对话定时发送

## 简介

一个为 SillyTavern 提供“按聊天对话绑定”的预约/定时发送功能的扩展。支持一次性、每日以及倒计时（定时）三种预约类型，并提供历史记录视图。

## 功能特点
- **按聊天独立**：让定时任务和聊天框绑定，不同聊天框之间定时任务相互隔离。
  - 注意：由于没有后端，必须打开网页的对应聊天框才能执行定时功能
- **三类预约**：
  - **一次性** once：到点即发，随后自动禁用。
  - **每日** daily：按每天固定时间点发送，触发后自动顺延到次日。
  - **定时** timer：按秒为单位的倒计时，可设置重复次数（0 代表无限）。
- **发送身份**：支持以“用户/角色/系统/原始”身份发送。
- **可选提示词**：可选择是否在时间戳后附带提示语（来源于具体预约配置）。
- **历史记录**：记录每次触发的发送文本与时间，支持导出/清空。

## 预约类型与触发规则（精确时刻，无容差窗口）
- 公共前提：
  - 当前激活聊天 + 扩展总开关开启 + 预约已启用。
- once（一次性）：
  - 仅当预约时间在“未来”时才调度；若在过去，预约将被禁用且不补发。
  - 触发后自动禁用。
- daily（每日）：
  - 仅需 `HH:mm`；若今日该时点已过，则顺延至次日同一时点。
  - 触发后顺延到下一天。
- timer（倒计时）：
  - `intervalSec ≥ 1`；创建时立即将 `nextAt` 设为“当前 + interval”。
  - 触发后：
    - `repeats > 0`：`remaining` 递减到 0 时停止；否则继续重排下一次。
    - `repeats = 0`：无限循环。

说明：实际触发精度由运行环境决定，前台一般秒级；浏览器后台标签可能被节流；桌面版最小化通常仍能秒级运行。

## 插入的提示词内容
- 格式：`[yyyy-MM-dd HH:mm:ss]` +（若开启“包含提示词”且预约配置了提示词则附带）。
- 提示词来源：
  - 一次性/每日：来自该预约的“提示语”。
  - 定时：来自该预约的“提示语列表”（随机一条）。

## 使用步骤
1. 打开任意聊天，进入扩展设置，切到“全局设置”，勾选“启用定时任务”。
2. 切到“新增预约”，选择类型并填写字段：
   - once：具体日期时间 +（可选）提示语。
   - daily：HH:mm +（可选）提示语。
   - timer：间隔秒、重复次数（0=无限）与多条提示语（每行一条，可选）。
3. 提交后，系统会立即计算 `nextAt` 并创建定时器；“预约列表”与“下次回复时间”会随之更新。
4. 触发记录可在“历史记录”查看与导出。

## 已知限制
- 仅“当前激活对话”会触发本对话的预约；切换聊天会仅为新聊天排程。
- 关闭扩展或关闭页面/窗口会导致计时器暂停。
- 浏览器后台标签可能被节流，触发时间存在延迟（与浏览器策略相关）。

## 常见问题
- 下次时间显示为 `--`？
  - 确认该预约已启用、扩展已启用；新建后会先排程再渲染，正常应显示具体时间。
  - 若仍为 `--`，尝试在“预约列表”点击“保存”以刷新 `nextAt`。
